{
  "Comment": "HaplotypeCaller Workflow",
  "StartAt": "Initialize",
  "States": {
    "Initialize": {
      "Type": "Pass",
      "InputPath": "$",
      "Parameters": {
        "workflow": {
          "name.$": "$$.StateMachine.Name",
          "execution.$": "$$.Execution.Name"
        },
        "params.$": "$.params",
        "jobdefs": {
          "gatk": "${BatchJobDefinitionGatk}"
        },
        "sample.$": "$.result[0]",
        "range.$": "$.result[1][0]"
      },
      "Next": "HaplotypeCaller"
    },
    "HaplotypeCaller": {
      "Type": "Task",
      "InputPath": "$",
      "ResultPath": null,
      "Resource": "arn:aws:states:::states:startExecution",
      "Parameters": {
        "Input": {
          "JobName": "haplotypecaller",
          "JobDefinition.$": "$.jobdefs.gatk",
          "JobQueue.$": "$.params.queue2",
          "RetryStrategy": {
            "Attempts": 4
          },
          "ContainerOverrides": {
            "Vcpus": 1,
            "Memory": 2000,
            "Environment": [
              {
                "Name": "JOB_WORKFLOW_NAME",
                "Value.$": "$.workflow.name"
              },
              {
                "Name": "JOB_WORKFLOW_EXECUTION_ID",
                "Value.$": "$.workflow.execution"
              },
              {
                "Name": "SOURCE_DATA_PREFIX",
                "Value.$": "$.params.environment.SOURCE_DATA_PREFIX"
              },
              {
                "Name": "JOB_INPUTS",
                "Value": "${!SOURCE_DATA_PREFIX}/REF/${!REFERENCE_NAME}.*"
              },
              {
                "Name": "JOB_OUTPUTS",
                "Value": "output/*"
              },
              {
                "Name": "JOB_OUTPUT_PREFIX_ENV",
                "Value.$": "$.params.environment.JOB_OUTPUT_PREFIX"
              },
              {
                "Name": "JOB_OUTPUT_PREFIX",
                "Value": "${!JOB_OUTPUT_PREFIX_ENV}/HC/${!CHR}/${!RANGE}"
              },
              {
                "Name": "JOB_AWS_CLI_PATH",
                "Value.$": "$.params.environment.JOB_AWS_CLI_PATH"
              },
              {
                "Name": "REFERENCE_NAME",
                "Value.$": "$.params.environment.REFERENCE_NAME"
              },
              {
                "Name": "SAMPLE_ID",
                "Value.$": "$.sample"
              },
              {
                "Name": "RANGE",
                "Value.$": "$.range"
              },
              {
                "Name": "CHR",
                "Value.$": "$.chrom.name"
              }
            ],
            "Command": [
              "mkdir -p output && gatk HaplotypeCaller -R ${!REFERENCE_NAME}.fna -I /scratch/working/${!SAMPLE_ID}.MarkDup.bam -L \"${!CHR}:${!RANGE}\" -O output/${!SAMPLE_ID}.g.vcf -ERC GVCF"
            ]
          },
          "Outputs": {
            "Bucket.$": "$.params.environment.JOB_OUTPUT",
            "Keys.$": "$.params.HC.outputs",
            "sample.$": "$.sample",
            "range.$": "$.range",
            "chrom.$": "$.chrom.name"
          },
          "Inputs": {
            "Bucket.$": "$.params.environment.JOB_OUTPUT",
            "Keys.$": "$.params.HC.inputs",
            "sample.$": "$.sample"
          }
        },
        "StateMachineArn": "${SubmitStateMachineArn}"
      },
      "End": true
    }
  }
}
